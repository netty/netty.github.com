<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Netty.news: Netty 4.0.0.CR5 released with new-new API</title>
    <title>Netty: Netty 4.0.0.CR5 released with new-new API</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="../../../../images/favicon.ico" rel="shortcut icon">
    <link href="http://feeds.feedburner.com/netty_project" rel="alternate" title="News Feed" type="application/rss+xml">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.no-icons.min.css" media="screen" rel="stylesheet" type="text/css">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" media="screen" rel="stylesheet" type="text/css">
    <script src="../../../../lib/sh/scripts/shCore.js" type="text/javascript"></script>
    <script src="../../../../lib/sh/scripts/shBrushXml.js" type="text/javascript"></script>
    <link href="../../../../lib/sh/styles/shCore.css" rel="stylesheet" type="text/css">
    <link href="../../../../lib/sh/styles/shThemeDefault.css" rel="stylesheet" type="text/css">
    <link href="../../../../lib/common.css" rel="stylesheet" type="text/css">
    <script src="../../../../lib/common.js" type="text/javascript"></script>
    <!--[if lt IE 9]>
      <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js" type="text/javascript"></script>
      <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.2.0/respond.min.js" type="text/javascript"></script>
    <![endif]-->
  </head>
  <body>
    <a class="sr-only" href="#content" id="top">Skip navigation</a>
    <nav class="navbar navbar-default navbar-fixed-top" id="header" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../../../index.html">
            <span class="navbar-brand-logo"></span>
            Netty project
          </a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="../../../../news/2013/09/05/3-7-0-Final.html">
                News
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a href="../../../../news/index.html">
                    <i class="icon-archive"></i>
                    Archive
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="../../../../downloads.html">
                Downloads
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a href="http://dl.bintray.com/netty/downloads/netty-4.0.7.Final.tar.bz2">
                    <i class="icon-download-alt"></i>
                    4.0.7.Final
                    <small>&dash; 08-Aug-2013</small>
                  </a>
                </li>
                <li>
                  <a href="http://dl.bintray.com/netty/downloads/netty-3.7.0.Final-dist.tar.bz2">
                    <i class="icon-download-alt"></i>
                    3.7.0.Final
                    <small>&dash; 05-Sep-2013</small>
                  </a>
                </li>
                <li>
                  <a href="http://www.tldrlegal.com/l/APACHE2">
                    <i class="icon-legal"></i>
                    Apache License 2.0
                  </a>
                </li>
                <li>
                  <a href="https://bintray.com/netty/downloads/netty/">
                    <i class="icon-archive"></i>
                    Previous Releases
                  </a>
                </li>
                <li>
                  <a href="http://ci.motd.kr/view/Netty/">
                    <i class="icon-beaker"></i>
                    Nightly Builds
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="../../../../wiki/index.html">
                Documentation
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a href="../../../../3.7/api/index.html">
                    <i class="icon-file-text"></i>
                    Javadoc - 3.7
                  </a>
                </li>
                <li>
                  <a href="../../../../4.0/api/index.html">
                    <i class="icon-file-text"></i>
                    Javadoc - 4.0
                  </a>
                </li>
                <li>
                  <a href="../../../../wiki/all-documents.html">
                    <i class="icon-list"></i>
                    All Documents
                  </a>
                </li>
                <li>
                  <a href="../../../../wiki/related-articles.html">
                    <i class="icon-bookmark"></i>
                    Related Articles
                  </a>
                </li>
                <li>
                  <a href="../../../../wiki/related-projects.html">
                    <i class="icon-bookmark"></i>
                    Related Projects
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="../../../../community.html">
                Get Involved
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a href="https://github.com/netty/netty">
                    <i class="icon-github"></i>
                    Github
                  </a>
                </li>
                <li>
                  <a href="http://stackoverflow.com/questions/tagged/netty">
                    <i class="icon-stackexchange"></i>
                    StackOverflow
                  </a>
                </li>
                <li>
                  <a href="https://twitter.com/netty_project">
                    <i class="icon-twitter-sign"></i>
                    @netty_project
                  </a>
                </li>
                <li>
                  <a href="../../../../wiki/developer-guide.html">
                    <i class="icon-cogs"></i>
                    Developer Guide
                  </a>
                </li>
              </ul>
            </li>
            <li>
              <a href="http://feeds.feedburner.com/netty_project">
                <i class="icon-rss"></i>
              </a>
            </li>
          </ul>
          <form action="../../../../search.html" class="navbar-form navbar-right" method="GET" onsubmit="return validateGlobalSearchQuery()" role="search">
            <div class="form-group">
              <input class="search-query form-control" id="global-search-query" name="q" placeholder="Search" type="text">
            </div>
          </form>
        </div>
      </div>
    </nav>
    <div id="content">
      <div class="container">
        <div class="news-item">
          <h1>
            Netty 4.0.0.CR5 released with new-new API
          </h1>
          <p class="byline">
            <small>
              by
              <a href="https://github.com/trustin">trustin</a>
              <br>
              on
              <time datetime="2013-06-18">18-Jun-2013</time>
            </small>
          </p>
          <div class="news-content">
            <p>You might already have seen we tagged 4.0.0.CR5 (and CR4) recently and wondered why no release announcement was coming along.  Here's the announcement finally with choke full of changes.</p>
            
            <p>This release is different from others because of its huge change in the API.  I'd like to apologize for the broken backward compatibility again and explain why this change was required.  Also, please read <a href="http://netty.io/wiki/user-guide-for-4.x.html">the revised user guide</a> and <a href="http://netty.io/wiki/new-and-noteworthy.html">the complete list of the changes in 4</a>.</p>
            
            <h2>Why breakage again?</h2>
            
            <p>The API changes made so far turned out to increase the memory footprint and consumption while our intention was actually decreasing them.</p>
            
            <h3>Memory consumption issue</h3>
            
            <p>When there are many connections which does not exchange data frequently, the old Netty 4 API spent a lot more memory than 3 because it always allocates per-handler buffer for each connection unless otherwise explicitly stated by a user.  In a usual real world load, a client doesn't always send requests without pausing, so the idea of having a buffer whose life cycle if bound to the life cycle of a connection didn't work as expected.</p>
            
            <h3>Memory footprint issue</h3>
            
            <p>The old Netty 4 API decreased overall memory footprint by a great deal in many cases.  It was mainly because the old Netty 4 API did not allocate a new buffer and event object for each read.  Instead, it created a new buffer for each handler in a pipeline.  This works pretty well as long as the number of handlers in a pipeline is only a few.  However, for a highly modular application with many handlers which handles connections which lasts for relatively short period, it actually makes the memory footprint issue much worse.</p>
            
            <h2>How did we fix them this time?</h2>
            
            <p>All in all, this is about retaining all the good changes we made in 4 so far such as better thread model and going back to the way how we dealt with message events in 3.  The distinction of <code>MessageBuf</code> and <code>ByteBuf</code> is now gone, and Netty simply treats a <code>ByteBuf</code> as a message just like Netty 3 did.  A <code>ByteBuf</code> is not allocated per handler anymore.</p>
            
            <p>To follow the change, the type hierarchy of <code>ChannelHandler</code> became very similar to that of Netty 3:</p>
            
            <p><img src="http://img.motd.kr/uml/gist/188244c4b3d6b01c0156" alt="ChannelHandler type hierarchy diagram" /></p>
            
            <p>Consequently, <code>inboundBufferUpdated()</code> and <code>flush()</code> were replaced by <code>messageReceived()</code> and <code>write()</code> (similar to <code>filterWrite()</code> in 3) respectively.</p>
            
            <p>Another change to note is that <code>MessageBuf</code> is gone and a new type called <code>MessageList</code> is used as a parameter of <code>messageReceived()</code> and <code>write()</code>.  It is basically a light-weight container of multiple messages.</p>
            
            <p>Due to the changes above, some handler implementations have no value anymore and thus were removed: <code>ByteToByteEncoder/Decoder/Codec</code>. Please use <code>MessageToByteEncoder&lt;ByteBuf&gt;</code>, <code>ByteToMessageDecoder&lt;ByteBuf&gt;</code>, and <code>ByteToMessageCodec&lt;ByteBuf&gt;</code> instead.</p>
            
            <p>Here are some other changes that might interest you:</p>
            
            <ul>
            <li><code>EmbeddedByteChannel</code> and <code>EmbeddedMessageChannel</code> has been merged into <code>EmbeddedChannel</code>.</li>
            <li><code>Channel.isWritable()</code> in 3 has been brought back.
            
            <ul>
            <li>Added <code>ChannelInboundHandler.channelWritabilityChanges()</code> event which is similar to <code>channelInterestOpsChanged()</code> in 3.</li>
            </ul>
            </li>
            <li>Because a handler does not have its own buffer, Netty has to allocate a new buffer whenever it reads something.  To get the optimal size of the new buffer, <code>RecvByteBufAllocator</code> has been added as a configuration property.
            
            <ul>
            <li>It is similar to <code>ReceiveBufferSizePredictor</code>.</li>
            <li>Some existing configuration properties such as
            <code>DatagramChannelConfig.receivePacketSize</code> is gone now.</li>
            </ul>
            </li>
            </ul>
            
            
            <h2>Other noteworthy changes</h2>
            
            <ul>
            <li><code>io.netty.buffer.ReferenceCounted</code> has been moved to <code>io.netty.util</code>. (<a href="https://github.com/netty/netty/issues/1441">#1441</a>)</li>
            <li>Resource leak detection has been turned on by default.</li>
            <li>The <code>ByteBuf</code> created by <code>PooledByteBufAllocator</code> produces zero garbage now if resource leak detection is turned off by <code>-Dio.netty.noResourceLeakDetection</code> JVM flag.</li>
            <li>The cancellation of <code>Future</code> and <code>Promise</code> works as expected now. (<a href="https://github.com/netty/netty/issues/1432">#1432</a>)</li>
            <li><code>GlobalEventExecutor</code> has been added to allow a user to execute an arbitrary task from a global singleton thread. (<a href="https://github.com/netty/netty/issues/1389">#1389</a>)</li>
            <li><code>Bootstrap.group()</code> getter method has been added for easier access to its underlying <code>EventLoopGroup</code>. (<a href="https://github.com/netty/netty/issues/1425">#1425</a>)</li>
            <li>Message type hierarchy of SPDY has been revised. (<a href="https://github.com/netty/netty/issues/1418">#1418</a>)</li>
            </ul>
            
            
            <p>Visit <a href="https://github.com/netty/netty/issues?milestone=53&amp;state=closed">here</a> for the complete list of the changes.</p>
            
            <h2>Acknowledgement</h2>
            
            <p>Every idea and bug-report counts and so we thought it is worth mentioning those who helped in this area. Please report an unintended omission.</p>
            
            <ul>
            <li><a href="https://github.com/coops">@coops</a></li>
            <li><a href="https://github.com/d-t-w">@d-t-w</a></li>
            <li><a href="https://github.com/DmitryLobachov">@DmitryLobachov</a></li>
            <li><a href="https://github.com/dpx-infinity">@dpx-infinity</a></li>
            <li><a href="https://github.com/hepin1989">@hepin1989</a></li>
            <li><a href="https://github.com/icafe">@icafe</a></li>
            <li><a href="https://github.com/jaens">@jaens</a></li>
            <li><a href="https://github.com/jpinner">@jpinner</a></li>
            <li><a href="https://github.com/listplot3d">@listplot3d</a></li>
            <li><a href="https://github.com/lurongbin">@lurongbin</a></li>
            <li><a href="https://github.com/mgiannini">@mgiannini</a></li>
            <li><a href="https://github.com/normanmaurer">@normanmaurer</a></li>
            <li><a href="https://github.com/profer">@profer</a></li>
            <li><a href="https://github.com/skayred">@skayred</a></li>
            <li><a href="https://github.com/sscarduzio">@sscarduzio</a></li>
            <li><a href="https://github.com/trustin">@trustin</a></li>
            </ul>
            
            
            <p>Last but not least, this change would have been impossible without <a href="https://github.com/normanmaurer">@normanmaurer</a>'s help. He fixed, ported, and improved many parts of my changes.</p>
          </div>
          <ul class="pager">
            <li class="previous">
              <a href="../../../../news/2013/05/15/3-6-6-Final.html">&larr; Older</a>
            </li>
            <li>
              <a href="../../../index.html">List all news items</a>
            </li>
            <li class="next">
              <a href="../../../../news/2013/06/21/4-0-0-CR6.html">Newer &rarr;</a>
            </li>
          </ul>
        </div>
        <div class="comments">
          
                      <div id="disqus_thread"></div>
                      <script type="text/javascript">
                      var disqus_shortname = 'netty0';
                      var disqus_url = "http://netty.io/news/2013/06/18/4-0-0-CR5.html";
                      var disqus_developer = null;
                      var disqus_identifier = "news/2013-06-18-4-0-0-CR5.html";
                      (function() {
                        var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
                        dsq.src = "http://netty0.disqus.com/embed.js";
                        (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
                      })();
                      </script>
                      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=netty0">comments powered by Disqus.</a></noscript>
        </div>
      </div>
    </div>
    <div class="container">
      <hr>
      <footer id="footer">
        <p>
          Copyright &copy; 2013
          <a href="../../../../index.html">The Netty project</a>
        </p>
      </footer>
    </div>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../../../lib/common.footer.js" type="text/javascript"></script>
  
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker('UA-95307-5');
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>
