<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Netty.docs: Reference counted objects</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="../images/favicon.ico" rel="shortcut icon">
    <link href="//feeds.feedburner.com/netty_project" rel="alternate" title="News Feed" type="application/rss+xml">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" media="screen" rel="stylesheet" type="text/css">
    <script src="../lib/sh/scripts/shCore.js" type="text/javascript"></script>
    <script src="../lib/sh/scripts/shBrushXml.js" type="text/javascript"></script>
    <link href="../lib/sh/styles/shCore.css" rel="stylesheet" type="text/css">
    <link href="../lib/sh/styles/shThemeDefault.css" rel="stylesheet" type="text/css">
    <link href="../lib/common.css" rel="stylesheet" type="text/css">
    <script src="../lib/common.js" type="text/javascript"></script>
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.js" type="text/javascript"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js" type="text/javascript"></script>
    <![endif]-->
  </head>
  <body>
    <a class="sr-only" href="#content" id="top">Skip navigation</a>
    <nav class="navbar navbar-default navbar-fixed-top hidden-print" id="header" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">
            <span class="navbar-brand-logo"></span>
            Netty project
          </a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="../news/2019/04/17/4-1-35-Final.html">
                News
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a href="../news/index.html">
                    <i class="fa fa-archive"></i>
                    Archive
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="../downloads.html">
                Downloads
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a href="https://dl.bintray.com/netty/downloads/netty-4.1.35.Final.tar.bz2">
                    <i class="fa fa-cloud-download"></i>
                    4.1.35.Final
                    <small>&dash; 17-Apr-2019</small>
                  </a>
                </li>
                <li>
                  <a href="https://dl.bintray.com/netty/downloads/netty-4.0.56.Final.tar.bz2">
                    <i class="fa fa-cloud-download"></i>
                    4.0.56.Final
                    <small>&dash; 05-Feb-2018</small>
                  </a>
                </li>
                <li>
                  <a href="https://dl.bintray.com/netty/downloads/netty-3.10.6.Final-dist.tar.bz2">
                    <i class="fa fa-cloud-download"></i>
                    3.10.6.Final
                    <small>&dash; 29-Jun-2016</small>
                  </a>
                </li>
                <li>
                  <a href="https://www.tldrlegal.com/l/APACHE2">
                    <i class="fa fa-gavel"></i>
                    Apache License 2.0
                  </a>
                </li>
                <li>
                  <a href="https://bintray.com/netty/downloads/netty/">
                    <i class="fa fa-archive"></i>
                    Previous Releases
                  </a>
                </li>
                <li>
                  <a href="https://oss.sonatype.org/content/repositories/snapshots/io/netty/">
                    <i class="fa fa-flask"></i>
                    Nightly Builds
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="../wiki/index.html">
                Documentation
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a href="../wiki/user-guide.html">
                    <i class="fa fa-book"></i>
                    User guide
                  </a>
                </li>
                <li>
                  <a href="../4.1/api/index.html">
                    <i class="fa fa-file-text"></i>
                    Javadoc - 4.1
                  </a>
                </li>
                <li>
                  <a href="../4.0/api/index.html">
                    <i class="fa fa-file-text"></i>
                    Javadoc - 4.0
                  </a>
                </li>
                <li>
                  <a href="../3.10/api/index.html">
                    <i class="fa fa-file-text"></i>
                    Javadoc - 3.10
                  </a>
                </li>
                <li>
                  <a href="../wiki/all-documents.html">
                    <i class="fa fa-list"></i>
                    All Documents
                  </a>
                </li>
                <li>
                  <a href="../wiki/related-articles.html">
                    <i class="fa fa-bookmark"></i>
                    Related Articles
                  </a>
                </li>
                <li class="hidden-xs" id="bookpromo-dropdown">
                  <a href="https://www.manning.com/maurer/">
                    <img src="../images/netty-in-action.gif">
                    <br>
                    <small>
                      Use code <strong>mlnettyco</strong>
                      <br>
                      for a 37% discount!
                    </small>
                  </a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="../community.html">
                Get Involved
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a href="https://github.com/netty/netty">
                    <i class="fa fa-github-square"></i>
                    Github
                  </a>
                </li>
                <li>
                  <a href="https://stackoverflow.com/questions/tagged/netty">
                    <i class="fa fa-stack-overflow"></i>
                    StackOverflow
                  </a>
                </li>
                <li>
                  <a href="https://twitter.com/netty_project">
                    <i class="fa fa-twitter-square"></i>
                    @netty_project
                  </a>
                </li>
                <li>
                  <a href="../wiki/developer-guide.html">
                    <i class="fa fa-cogs"></i>
                    Developer Guide
                  </a>
                </li>
                <li>
                  <a href="https://webchat.freenode.net/?channels=%23netty&amp;uio=MT1mYWxzZSY5PXRydWU13">
                    <i class="fa fa-comment"></i>
                    IRC Chat
                  </a>
                </li>
                <li>
                  <a href="../sponsor/thanks.html">
                    <i class="fa fa-usd"></i>
                    Sponsors
                  </a>
                </li>
                <li>
                  <a href="../wiki/adopters.html">
                    <i class="fa fa-users"></i>
                    Adopters
                  </a>
                </li>
                <li>
                  <a href="../wiki/related-projects.html">
                    <i class="fa fa-chain"></i>
                    Related Projects
                  </a>
                </li>
              </ul>
            </li>
            <li class="visible-xs" id="bookpromo-nav">
              <a href="https://www.manning.com/maurer/">
                <img src="../images/netty-in-action.gif">
                <br>
                <small>
                  Use code <strong>mlnettyco</strong>
                  <br>
                  for a 37% discount!
                </small>
              </a>
            </li>
            <li>
              <a href="https://feeds.feedburner.com/netty_project">
                <i class="fa fa-rss"></i>
              </a>
            </li>
          </ul>
          <form action="../search.html" class="navbar-form navbar-right hidden-sm" method="GET" onsubmit="return validateGlobalSearchQuery()" role="search">
            <div class="form-group">
              <input class="search-query form-control" id="global-search-query" name="q" placeholder="Search" type="text">
            </div>
          </form>
        </div>
      </div>
    </nav>
    <div id="content">
      <div class="container">
        <div class="wiki-item">
          <h1>Reference counted objects</h1>
          <div class="alert alert-info">
            Did you know this page is automatically generated from
            <a href="https://github.com/netty/netty/wiki/Reference-counted-objects">a Github Wiki page?</a>
            You can improve it by yourself
            <a href="https://github.com/netty/netty/wiki/Reference-counted-objects">here!</a>
          </div>
          <div class="row">
          <div class="col-md-9">
          <div id="wiki-body" class="mt-4 flex-auto min-width-0 gollum-markdown-content instapaper_body">
                  <div class="markdown-body">
                    <p>Since Netty version 4, the life cycle of certain objects are managed by their reference counts, so that Netty can return them (or their shared resources) to an object pool (or an object allocator) as soon as it is not used anymore.  Garbage collection and reference queues do not provide such efficient real-time guarantee of unreachability while reference-counting provides an alternative mechanism at the cost of slight inconvenience.</p>
          <p><a href="http://netty.io/4.0/api/index.html?io/netty/buffer/ByteBuf.html" rel="nofollow"><code>ByteBuf</code></a> is the most notable type which takes advantage of reference counting to improve the allocation and deallocation performance, and this page will explain how reference counting in Netty works using <code>ByteBuf</code>.</p>
          <h2 id="wiki-h2-0">
          <a id="user-content-basics-of-reference-counting" class="anchor" href="#basics-of-reference-counting" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Basics of reference counting</h2>
          <p>The initial reference count of a new reference-counted object is 1:</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-smi">ByteBuf</span> buf <span class="pl-k">=</span> ctx<span class="pl-k">.</span>alloc()<span class="pl-k">.</span>directBuffer();&#x000A;<span class="pl-k">assert</span> buf<span class="pl-k">.</span>refCnt() <span class="pl-k">==</span> <span class="pl-c1">1</span>;</pre></div>
          <p>When you release the reference-counted object, its reference count is decreased by 1.  If the reference count reaches at 0, the reference-counted object is deallocated or returned to the object pool it came from:</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-k">assert</span> buf<span class="pl-k">.</span>refCnt() <span class="pl-k">==</span> <span class="pl-c1">1</span>;&#x000A;<span class="pl-c"><span class="pl-c">//</span> release() returns true only if the reference count becomes 0.</span>&#x000A;<span class="pl-k">boolean</span> destroyed <span class="pl-k">=</span> buf<span class="pl-k">.</span>release();&#x000A;<span class="pl-k">assert</span> destroyed;&#x000A;<span class="pl-k">assert</span> buf<span class="pl-k">.</span>refCnt() <span class="pl-k">==</span> <span class="pl-c1">0</span>;</pre></div>
          <h3 id="wiki-h3-1">
          <a id="user-content-dangling-reference" class="anchor" href="#dangling-reference" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dangling reference</h3>
          <p>Attempting to access the reference-counted object whose reference count is 0 will trigger an <code>IllegalReferenceCountException</code>:</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-k">assert</span> buf<span class="pl-k">.</span>refCnt() <span class="pl-k">==</span> <span class="pl-c1">0</span>;&#x000A;<span class="pl-k">try</span> {&#x000A;  buf<span class="pl-k">.</span>writeLong(<span class="pl-c1">0xdeadbeef</span>);&#x000A;  <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-smi">Error</span>(<span class="pl-s"><span class="pl-pds">"</span>should not reach here<span class="pl-pds">"</span></span>);&#x000A;} <span class="pl-k">catch</span> (<span class="pl-smi">IllegalReferenceCountExeception</span> e) {&#x000A;  <span class="pl-c"><span class="pl-c">//</span> Expected</span>&#x000A;}</pre></div>
          <h3 id="wiki-h3-2">
          <a id="user-content-increasing-the-reference-count" class="anchor" href="#increasing-the-reference-count" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Increasing the reference count</h3>
          <p>A reference count can also be incremented via the <code>retain()</code> operation as long as it is not destroyed yet:</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-smi">ByteBuf</span> buf <span class="pl-k">=</span> ctx<span class="pl-k">.</span>alloc()<span class="pl-k">.</span>directBuffer();&#x000A;<span class="pl-k">assert</span> buf<span class="pl-k">.</span>refCnt() <span class="pl-k">==</span> <span class="pl-c1">1</span>;&#x000A;&#x000A;buf<span class="pl-k">.</span>retain();&#x000A;<span class="pl-k">assert</span> buf<span class="pl-k">.</span>refCnt() <span class="pl-k">==</span> <span class="pl-c1">2</span>;&#x000A;&#x000A;<span class="pl-k">boolean</span> destroyed <span class="pl-k">=</span> buf<span class="pl-k">.</span>release();&#x000A;<span class="pl-k">assert</span> <span class="pl-k">!</span>destroyed;&#x000A;<span class="pl-k">assert</span> buf<span class="pl-k">.</span>refCnt() <span class="pl-k">==</span> <span class="pl-c1">1</span>;</pre></div>
          <h3 id="wiki-h3-3">
          <a id="user-content-who-destroys-it" class="anchor" href="#who-destroys-it" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Who destroys it?</h3>
          <p>The general rule of thumb is that the party who accesses a reference-counted object lastly is responsible for the destruction of the reference-counted object. More specifically:</p>
          <ul>
          <li>If a [sending] component is supposed to pass a reference-counted object to another [receiving] component, the sending component usually does not need to destroy it but defers that decision to the receiving component.</li>
          <li>If a component consumes a reference-counted object and knows nothing else will access it anymore (i.e., does not pass along a reference to yet another component), the component should destroy it.</li>
          </ul>
          <p>Here is a simple example:</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-smi">ByteBuf</span> a(<span class="pl-smi">ByteBuf</span> input) {&#x000A;    input<span class="pl-k">.</span>writeByte(<span class="pl-c1">42</span>);&#x000A;    <span class="pl-k">return</span> input;&#x000A;}&#x000A;&#x000A;<span class="pl-k">public</span> <span class="pl-smi">ByteBuf</span> b(<span class="pl-smi">ByteBuf</span> input) {&#x000A;    <span class="pl-k">try</span> {&#x000A;        output <span class="pl-k">=</span> input<span class="pl-k">.</span>alloc()<span class="pl-k">.</span>directBuffer(input<span class="pl-k">.</span>readableBytes() <span class="pl-k">+</span> <span class="pl-c1">1</span>);&#x000A;        output<span class="pl-k">.</span>writeBytes(input);&#x000A;        output<span class="pl-k">.</span>writeByte(<span class="pl-c1">42</span>);&#x000A;        <span class="pl-k">return</span> output;&#x000A;    } <span class="pl-k">finally</span> {&#x000A;        input<span class="pl-k">.</span>release();&#x000A;    }&#x000A;}&#x000A;&#x000A;<span class="pl-k">public</span> <span class="pl-k">void</span> c(<span class="pl-smi">ByteBuf</span> input) {&#x000A;    <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(input);&#x000A;    input<span class="pl-k">.</span>release();&#x000A;}&#x000A;&#x000A;<span class="pl-k">public</span> <span class="pl-k">void</span> main() {&#x000A;    <span class="pl-c1">...</span>&#x000A;    <span class="pl-smi">ByteBuf</span> buf <span class="pl-k">=</span> <span class="pl-c1">...</span>;&#x000A;    <span class="pl-c"><span class="pl-c">//</span> This will print buf to System.out and destroy it.</span>&#x000A;    c(b(a(buf)));&#x000A;    <span class="pl-k">assert</span> buf<span class="pl-k">.</span>refCnt() <span class="pl-k">==</span> <span class="pl-c1">0</span>;&#x000A;}</pre></div>
          <table class="table table-hover">
          <thead>
          <tr>
          <th>Action</th>
          <th>Who should release?</th>
          <th>Who released?</th>
          </tr>
          </thead>
          <tbody>
          <tr>
          <td>1. <code>main()</code> creates <code>buf</code>
          </td>
          <td>
          <code>buf</code>→<code>main()</code>
          </td>
          <td></td>
          </tr>
          <tr>
          <td>2. <code>main()</code> calls <code>a()</code> with <code>buf</code>
          </td>
          <td>
          <code>buf</code>→<code>a()</code>
          </td>
          <td></td>
          </tr>
          <tr>
          <td>3. <code>a()</code> returns <code>buf</code> merely.</td>
          <td>
          <code>buf</code>→<code>main()</code>
          </td>
          <td></td>
          </tr>
          <tr>
          <td>4. <code>main()</code> calls <code>b()</code> with <code>buf</code>
          </td>
          <td>
          <code>buf</code>→<code>b()</code>
          </td>
          <td></td>
          </tr>
          <tr>
          <td>5. <code>b()</code> returns the copy of <code>buf</code>
          </td>
          <td>
          <code>buf</code>→<code>b()</code>, <code>copy</code>→<code>main()</code>
          </td>
          <td>
          <code>b()</code> releases <code>buf</code>
          </td>
          </tr>
          <tr>
          <td>6. <code>main()</code> calls <code>c()</code> with <code>copy</code>
          </td>
          <td>
          <code>copy</code>→<code>c()</code>
          </td>
          <td></td>
          </tr>
          <tr>
          <td>7. <code>c()</code> swallows <code>copy</code>
          </td>
          <td>
          <code>copy</code>→<code>c()</code>
          </td>
          <td>
          <code>c()</code> releases <code>copy</code>
          </td>
          </tr>
          </tbody>
          </table>
          <h3 id="wiki-h3-4">
          <a id="user-content-derived-buffers" class="anchor" href="#derived-buffers" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Derived buffers</h3>
          <p><code>ByteBuf.duplicate()</code>, <code>ByteBuf.slice()</code> and <code>ByteBuf.order(ByteOrder)</code> create a <em>derived</em> buffer which shares the memory region of the parent buffer.  A derived buffer does not have its own reference count but shares the reference count of the parent buffer.</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-smi">ByteBuf</span> parent <span class="pl-k">=</span> ctx<span class="pl-k">.</span>alloc()<span class="pl-k">.</span>directBuffer();&#x000A;<span class="pl-smi">ByteBuf</span> derived <span class="pl-k">=</span> parent<span class="pl-k">.</span>duplicate();&#x000A;&#x000A;<span class="pl-c"><span class="pl-c">//</span> Creating a derived buffer does not increase the reference count.</span>&#x000A;<span class="pl-k">assert</span> parent<span class="pl-k">.</span>refCnt() <span class="pl-k">==</span> <span class="pl-c1">1</span>;&#x000A;<span class="pl-k">assert</span> derived<span class="pl-k">.</span>refCnt() <span class="pl-k">==</span> <span class="pl-c1">1</span>;</pre></div>
          <p>In contrast, <code>ByteBuf.copy()</code> and <code>ByteBuf.readBytes(int)</code> are <em>not derived</em> buffers.  The returned <code>ByteBuf</code> is allocated will need to be released.</p>
          <p>Note that a parent buffer and its derived buffers share the same reference count, and the reference count does not increase when a derived buffer is created.  Therefore, if you are going to pass a derived buffer to other component of your application, you'll have to call <code>retain()</code> it first.</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-smi">ByteBuf</span> parent <span class="pl-k">=</span> ctx<span class="pl-k">.</span>alloc()<span class="pl-k">.</span>directBuffer(<span class="pl-c1">512</span>);&#x000A;parent<span class="pl-k">.</span>writeBytes(<span class="pl-c1">...</span>);&#x000A;&#x000A;<span class="pl-k">try</span> {&#x000A;    <span class="pl-k">while</span> (parent<span class="pl-k">.</span>isReadable(<span class="pl-c1">16</span>)) {&#x000A;        <span class="pl-smi">ByteBuf</span> derived <span class="pl-k">=</span> parent<span class="pl-k">.</span>readSlice(<span class="pl-c1">16</span>);&#x000A;        derived<span class="pl-k">.</span>retain();&#x000A;        process(derived);&#x000A;    }&#x000A;} <span class="pl-k">finally</span> {&#x000A;    parent<span class="pl-k">.</span>release();&#x000A;}&#x000A;<span class="pl-c1">...</span>&#x000A;&#x000A;<span class="pl-k">public</span> <span class="pl-k">void</span> process(<span class="pl-smi">ByteBuf</span> buf) {&#x000A;    <span class="pl-c1">...</span>&#x000A;    buf<span class="pl-k">.</span>release();&#x000A;}</pre></div>
          <h3 id="wiki-h3-5">
          <a id="user-content-bytebufholder-interface" class="anchor" href="#bytebufholder-interface" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>ByteBufHolder</code> interface</h3>
          <p>Sometimes, a <code>ByteBuf</code> is contained by a buffer holder, such as <a href="http://netty.io/4.0/api/index.html?io/netty/channel/socket/DatagramPacket.html" rel="nofollow"><code>DatagramPacket</code></a>, <a href="http://netty.io/4.0/api/index.html?io/netty/handler/codec/http/HttpContent.html" rel="nofollow"><code>HttpContent</code></a>, and <a href="http://netty.io/4.0/api/index.html?io/netty/handler/codec/http/websocketx/WebSocketFrame.html" rel="nofollow"><code>WebSocketframe</code></a>.  Those types extend a common interface called <a href="http://netty.io/4.0/api/index.html?io/netty/buffer/ByteBufHolder.html" rel="nofollow"><code>ByteBufHolder</code></a>.</p>
          <p>A buffer holder shares the reference count of the buffer it contains, just like a derived buffer.</p>
          <h2 id="wiki-h2-6">
          <a id="user-content-reference-counting-in-channelhandler" class="anchor" href="#reference-counting-in-channelhandler" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reference-counting in <code>ChannelHandler</code>
          </h2>
          <h3 id="wiki-h3-7">
          <a id="user-content-inbound-messages" class="anchor" href="#inbound-messages" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Inbound messages</h3>
          <p>When an event loop reads data into a <code>ByteBuf</code> and triggers a <code>channelRead()</code> event with it, it is the responsibility of the <code>ChannelHandler</code> in the corresponding pipeline to release the buffer.  Therefore, the handler that consumes the received data should call <code>release()</code> on the data in its <code>channelRead()</code> handler method:</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">void</span> channelRead(<span class="pl-smi">ChannelHandlerContext</span> ctx, <span class="pl-smi">Object</span> msg) {&#x000A;    <span class="pl-smi">ByteBuf</span> buf <span class="pl-k">=</span> (<span class="pl-smi">ByteBuf</span>) msg;&#x000A;    <span class="pl-k">try</span> {&#x000A;        <span class="pl-c1">...</span>&#x000A;    } <span class="pl-k">finally</span> {&#x000A;        buf<span class="pl-k">.</span>release();&#x000A;    }&#x000A;}</pre></div>
          <p>As explained in the 'Who destroys?' section of this document, if your handler passes the buffer (or any reference-counted object) to the next handler, you don't need to release it:</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">void</span> channelRead(<span class="pl-smi">ChannelHandlerContext</span> ctx, <span class="pl-smi">Object</span> msg) {&#x000A;    <span class="pl-smi">ByteBuf</span> buf <span class="pl-k">=</span> (<span class="pl-smi">ByteBuf</span>) msg;&#x000A;    <span class="pl-c1">...</span>&#x000A;    ctx<span class="pl-k">.</span>fireChannelRead(buf);&#x000A;}</pre></div>
          <p>Note that <code>ByteBuf</code> isn't the only reference-counted type in Netty.  If you are dealing with the messages generated by decoders, it is very likely that the message is also reference-counted:</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-c"><span class="pl-c">//</span> Assuming your handler is placed next to `HttpRequestDecoder`</span>&#x000A;<span class="pl-k">public</span> <span class="pl-k">void</span> channelRead(<span class="pl-smi">ChannelHandlerContext</span> ctx, <span class="pl-smi">Object</span> msg) {&#x000A;    <span class="pl-k">if</span> (msg <span class="pl-k">instanceof</span> <span class="pl-smi">HttpRequest</span>) {&#x000A;        <span class="pl-smi">HttpRequest</span> req <span class="pl-k">=</span> (<span class="pl-smi">HttpRequest</span>) msg;&#x000A;        <span class="pl-c1">...</span>&#x000A;    }&#x000A;    <span class="pl-k">if</span> (msg <span class="pl-k">instanceof</span> <span class="pl-smi">HttpContent</span>) {&#x000A;        <span class="pl-smi">HttpContent</span> content <span class="pl-k">=</span> (<span class="pl-smi">HttpContent</span>) msg;&#x000A;        <span class="pl-k">try</span> {&#x000A;            <span class="pl-c1">...</span>&#x000A;        } <span class="pl-k">finally</span> {&#x000A;            content<span class="pl-k">.</span>release();&#x000A;        }&#x000A;    }&#x000A;}</pre></div>
          <p>If you are in doubt or you want to simplify releasing the messages, you can use <code>ReferenceCountUtil.release()</code>:</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-k">public</span> <span class="pl-k">void</span> channelRead(<span class="pl-smi">ChannelHandlerContext</span> ctx, <span class="pl-smi">Object</span> msg) {&#x000A;    <span class="pl-k">try</span> {&#x000A;        <span class="pl-c1">...</span>&#x000A;    } <span class="pl-k">finally</span> {&#x000A;        <span class="pl-smi">ReferenceCountUtil</span><span class="pl-k">.</span>release(msg);&#x000A;    }&#x000A;}</pre></div>
          <p>Alternatively, you could consider extending <code>SimpleChannelHandler</code> which calls <code>ReferenceCountUtil.release(msg)</code> for all messages you receive.</p>
          <h3 id="wiki-h3-8">
          <a id="user-content-outbound-messages" class="anchor" href="#outbound-messages" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Outbound messages</h3>
          <p>Unlike inbound messages, outbound messages are created by your application, and it is the responsibility of Netty to release these after writing them out to the wire.  However, the handlers that intercept your write requests should make sure to release any intermediary objects properly. (e.g. encoders)</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-c"><span class="pl-c">//</span> Simple-pass through</span>&#x000A;<span class="pl-k">public</span> <span class="pl-k">void</span> write(<span class="pl-smi">ChannelHandlerContext</span> ctx, <span class="pl-smi">Object</span> message, <span class="pl-smi">ChannelPromise</span> promise) {&#x000A;    <span class="pl-smi">System</span><span class="pl-k">.</span>err<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>Writing: <span class="pl-pds">"</span></span> <span class="pl-k">+</span> message);&#x000A;    ctx<span class="pl-k">.</span>write(message, promise);&#x000A;}&#x000A;&#x000A;<span class="pl-c"><span class="pl-c">//</span> Transformation</span>&#x000A;<span class="pl-k">public</span> <span class="pl-k">void</span> write(<span class="pl-smi">ChannelHandlerContext</span> ctx, <span class="pl-smi">Object</span> message, <span class="pl-smi">ChannelPromise</span> promise) {&#x000A;    <span class="pl-k">if</span> (message <span class="pl-k">instanceof</span> <span class="pl-smi">HttpContent</span>) {&#x000A;        <span class="pl-c"><span class="pl-c">//</span> Transform HttpContent to ByteBuf.</span>&#x000A;        <span class="pl-smi">HttpContent</span> content <span class="pl-k">=</span> (<span class="pl-smi">HttpContent</span>) message;&#x000A;        <span class="pl-k">try</span> {&#x000A;            <span class="pl-smi">ByteBuf</span> transformed <span class="pl-k">=</span> ctx<span class="pl-k">.</span>alloc()<span class="pl-k">.</span>buffer();&#x000A;            <span class="pl-c1">....</span>&#x000A;            ctx<span class="pl-k">.</span>write(transformed, promise);&#x000A;        } <span class="pl-k">finally</span> {&#x000A;            content<span class="pl-k">.</span>release();&#x000A;        }&#x000A;    } <span class="pl-k">else</span> {&#x000A;        <span class="pl-c"><span class="pl-c">//</span> Pass non-HttpContent through.</span>&#x000A;        ctx<span class="pl-k">.</span>write(message, promise);&#x000A;    }&#x000A;}</pre></div>
          <h2 id="wiki-h2-9">
          <a id="user-content-troubleshooting-buffer-leaks" class="anchor" href="#troubleshooting-buffer-leaks" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Troubleshooting buffer leaks</h2>
          <p>The disadvantage of reference counting is that it is easy to leak the reference-counted objects.  Because JVM is not aware of the reference counting Netty implements, it will automatically GC them once they become unreachable even if their reference counts are not zero. An object once garbage collected cannot be resurrected, and thus cannot be returned to the pool it came from and thus will produce memory leak.</p>
          <p>Fortunately, despite its difficulty of finding leaks, Netty will by default sample about 1% of buffer allocations to check if there is a leak in your application.  In case of leak, you will find the following log message:</p>
          <blockquote>
          <p><code>LEAK: ByteBuf.release() was not called before it's garbage-collected. Enable advanced leak reporting to find out where the leak occurred. To enable advanced leak reporting, specify the JVM option '-Dio.netty.leakDetectionLevel=advanced' or call ResourceLeakDetector.setLevel()</code></p>
          </blockquote>
          <p>Relaunch your application with the JVM option mentioned above, then you'll see the recent locations of your application where the leaked buffer was accessed.  The following output shows a leak from our unit test (<code>XmlFrameDecoderTest.testDecodeWithXml()</code>):</p>
          <pre><code>Running io.netty.handler.codec.xml.XmlFrameDecoderTest&#x000A;15:03:36.886 [main] ERROR io.netty.util.ResourceLeakDetector - LEAK: ByteBuf.release() was not called before it's garbage-collected.&#x000A;Recent access records: 1&#x000A;#1:&#x000A;	io.netty.buffer.AdvancedLeakAwareByteBuf.toString(AdvancedLeakAwareByteBuf.java:697)&#x000A;	io.netty.handler.codec.xml.XmlFrameDecoderTest.testDecodeWithXml(XmlFrameDecoderTest.java:157)&#x000A;	io.netty.handler.codec.xml.XmlFrameDecoderTest.testDecodeWithTwoMessages(XmlFrameDecoderTest.java:133)&#x000A;	...&#x000A;&#x000A;Created at:&#x000A;	io.netty.buffer.UnpooledByteBufAllocator.newDirectBuffer(UnpooledByteBufAllocator.java:55)&#x000A;	io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:155)&#x000A;	io.netty.buffer.UnpooledUnsafeDirectByteBuf.copy(UnpooledUnsafeDirectByteBuf.java:465)&#x000A;	io.netty.buffer.WrappedByteBuf.copy(WrappedByteBuf.java:697)&#x000A;	io.netty.buffer.AdvancedLeakAwareByteBuf.copy(AdvancedLeakAwareByteBuf.java:656)&#x000A;	io.netty.handler.codec.xml.XmlFrameDecoder.extractFrame(XmlFrameDecoder.java:198)&#x000A;	io.netty.handler.codec.xml.XmlFrameDecoder.decode(XmlFrameDecoder.java:174)&#x000A;	io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:227)&#x000A;	io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:140)&#x000A;	io.netty.channel.ChannelHandlerInvokerUtil.invokeChannelReadNow(ChannelHandlerInvokerUtil.java:74)&#x000A;	io.netty.channel.embedded.EmbeddedEventLoop.invokeChannelRead(EmbeddedEventLoop.java:142)&#x000A;	io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:317)&#x000A;	io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:846)&#x000A;	io.netty.channel.embedded.EmbeddedChannel.writeInbound(EmbeddedChannel.java:176)&#x000A;	io.netty.handler.codec.xml.XmlFrameDecoderTest.testDecodeWithXml(XmlFrameDecoderTest.java:147)&#x000A;	io.netty.handler.codec.xml.XmlFrameDecoderTest.testDecodeWithTwoMessages(XmlFrameDecoderTest.java:133)&#x000A;	...&#x000A;</code></pre>
          <p>If you use Netty 5 or above, an additional information is provided to help you find which handler handled the leaked buffer lastly.  The following example shows that the leaked buffer was handled by the handler whose name is <code>EchoServerHandler#0</code> and then garbage-collected, which means it is likely that <code>EchoServerHandler#0</code> forgot to release the buffer:</p>
          <pre><code>12:05:24.374 [nioEventLoop-1-1] ERROR io.netty.util.ResourceLeakDetector - LEAK: ByteBuf.release() was not called before it's garbage-collected.&#x000A;Recent access records: 2&#x000A;#2:&#x000A;	Hint: 'EchoServerHandler#0' will handle the message from this point.&#x000A;	io.netty.channel.DefaultChannelHandlerContext.fireChannelRead(DefaultChannelHandlerContext.java:329)&#x000A;	io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:846)&#x000A;	io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:133)&#x000A;	io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:485)&#x000A;	io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:452)&#x000A;	io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:346)&#x000A;	io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:794)&#x000A;	java.lang.Thread.run(Thread.java:744)&#x000A;#1:&#x000A;	io.netty.buffer.AdvancedLeakAwareByteBuf.writeBytes(AdvancedLeakAwareByteBuf.java:589)&#x000A;	io.netty.channel.socket.nio.NioSocketChannel.doReadBytes(NioSocketChannel.java:208)&#x000A;	io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:125)&#x000A;	io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:485)&#x000A;	io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:452)&#x000A;	io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:346)&#x000A;	io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:794)&#x000A;	java.lang.Thread.run(Thread.java:744)&#x000A;Created at:&#x000A;	io.netty.buffer.UnpooledByteBufAllocator.newDirectBuffer(UnpooledByteBufAllocator.java:55)&#x000A;	io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:155)&#x000A;	io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:146)&#x000A;	io.netty.buffer.AbstractByteBufAllocator.ioBuffer(AbstractByteBufAllocator.java:107)&#x000A;	io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:123)&#x000A;	io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:485)&#x000A;	io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:452)&#x000A;	io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:346)&#x000A;	io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:794)&#x000A;	java.lang.Thread.run(Thread.java:744)&#x000A;</code></pre>
          <h3 id="wiki-h3-10">
          <a id="user-content-leak-detection-levels" class="anchor" href="#leak-detection-levels" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Leak detection levels</h3>
          <p>There are currently 4 levels of leak detection:</p>
          <ul>
          <li>
          <code>DISABLED</code> - disables leak detection completely. Not recommended.</li>
          <li>
          <code>SIMPLE</code> - tells if there is a leak or not for 1% of buffers. Default.</li>
          <li>
          <code>ADVANCED</code> - tells where the leaked buffer was accessed for 1% of buffers.</li>
          <li>
          <code>PARANOID</code> - Same with <code>ADVANCED</code> except that it's for every single buffer.  Useful for automated testing phase. You could fail the build if the build output contains '<code>LEAK: </code>'.</li>
          </ul>
          <p>You can specify the leak detection level as a JVM option <code>-Dio.netty.leakDetection.level</code></p>
          <pre><code>java -Dio.netty.leakDetection.level=advanced ...&#x000A;</code></pre>
          <p><strong>NOTE</strong>: This property used to be called <code>io.netty.leakDetectionLevel</code>.</p>
          <h3 id="wiki-h3-11">
          <a id="user-content-best-practices-to-avoid-leaks" class="anchor" href="#best-practices-to-avoid-leaks" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Best practices to avoid leaks</h3>
          <ul>
          <li>Run your unit tests and integration tests at <code>PARANOID</code> leak detection level, as well as at <code>SIMPLE</code> level.</li>
          <li>Canary your application before rolling out to the entire cluster at <code>SIMPLE</code> level for a reasonably long time to see if there's a leak.</li>
          <li>If there is a leak, canary again at <code>ADVANCED</code> level to get some hints about where the leak is coming from.</li>
          <li>Do not deploy an application with a leak to the entire cluster.</li>
          </ul>
          <h3 id="wiki-h3-12">
          <a id="user-content-fixing-leaks-in-unit-tests" class="anchor" href="#fixing-leaks-in-unit-tests" aria-hidden="true"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fixing leaks in unit tests</h3>
          <p>It is very easy to forget to release a buffer or a message in a unit test.  It will generate a leak warning, but it does not necessarily mean that your application has a leak.  Instead of wrapping your unit tests with <code>try-finally</code> blocks to release all buffers, you can use <code>ReferenceCountUtil.releaseLater()</code> utility method:</p>
          <div class="highlight highlight-source-java"><pre><span class="pl-k">import static</span> <span class="pl-smi">io.netty.util.ReferenceCountUtil.*</span>;&#x000A;&#x000A;<span class="pl-k">@Test</span>&#x000A;<span class="pl-k">public</span> <span class="pl-k">void</span> testSomething() throws <span class="pl-smi">Exception</span> {&#x000A;    <span class="pl-c"><span class="pl-c">//</span> ReferenceCountUtil.releaseLater() will keep the reference of buf,</span>&#x000A;    <span class="pl-c"><span class="pl-c">//</span> and then release it when the test thread is terminated.</span>&#x000A;    <span class="pl-smi">ByteBuf</span> buf <span class="pl-k">=</span> releaseLater(<span class="pl-smi">Unpooled</span><span class="pl-k">.</span>directBuffer(<span class="pl-c1">512</span>));&#x000A;    <span class="pl-c1">...</span>&#x000A;}</pre></div>
          <hr>
          <p><strong>External Links:</strong></p>
          <p><a href="http://stackoverflow.com/questions/28647048/why-do-we-need-to-manually-handle-reference-counting-for-netty-bytebuf-if-jvm-gc" rel="nofollow">Why do we need to manually handle reference counting for Netty ByteBuf if JVM GC is still in place?</a></p>
          <p><a href="http://stackoverflow.com/questions/15781276/buffer-ownership-in-netty-4-how-is-buffer-life-cycle-managed" rel="nofollow">Buffer ownership in Netty 4: How is buffer life-cycle managed?</a></p>
          
                  </div>
          
              </div></div>
          <div class="toc-container col-md-3 hidden-xs hidden-sm hidden-print" role="complementary">
          <div class="toc well">
          <ul class="nav nav-list nav-stacked">
          <li class="nav-header">Table of Contents
          </li><li><a href="#wiki-h2-0" title="Basics of reference counting">Basics of reference counting</a>
          <ul class="nav nav-list nav-stacked"><li><a href="#wiki-h3-1" title="Dangling reference">Dangling reference</a>
          </li><li><a href="#wiki-h3-2" title="Increasing the reference count">Increasing the reference count</a>
          </li><li><a href="#wiki-h3-3" title="Who destroys it?">Who destroys it?</a>
          </li><li><a href="#wiki-h3-4" title="Derived buffers">Derived buffers</a>
          </li><li><a href="#wiki-h3-5" title="ByteBufHolder interface">ByteBufHolder interface</a>
          </li></ul></li><li><a href="#wiki-h2-6" title="Reference-counting in ChannelHandler">Reference-counting in ChannelHandler</a>
          <ul class="nav nav-list nav-stacked"><li><a href="#wiki-h3-7" title="Inbound messages">Inbound messages</a>
          </li><li><a href="#wiki-h3-8" title="Outbound messages">Outbound messages</a>
          </li></ul></li><li><a href="#wiki-h2-9" title="Troubleshooting buffer leaks">Troubleshooting buffer leaks</a>
          <ul class="nav nav-list nav-stacked"><li><a href="#wiki-h3-10" title="Leak detection levels">Leak detection levels</a>
          </li><li><a href="#wiki-h3-11" title="Best practices to avoid leaks">Best practices to avoid leaks</a>
          </li><li><a href="#wiki-h3-12" title="Fixing leaks in unit tests">Fixing leaks in unit tests</a>
          </li><li><a href="#wiki-h3-13" title="Pages 27">Pages 27</a>
          </li></ul>
          </li></ul>
          </div>
          </div>
          </div>
          <div class="row">
            <div class="col-md-9">
              <div class="text-right">
                <small>Last retrieved on 17-Apr-2019</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <hr>
      <div id="footer">
        <p>
          Copyright &copy; 2019
          <a href="../index.html">The Netty project</a>
        </p>
      </div>
    </div>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../lib/common.footer.js" type="text/javascript"></script>
  
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-95307-5', 'auto');
ga('require', 'displayfeatures');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview');
</script>
</body>
</html>
